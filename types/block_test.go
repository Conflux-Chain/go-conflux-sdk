package types

import (
	"encoding/hex"
	"github.com/Conflux-Chain/go-conflux-sdk/utils"
	"testing"

	"github.com/ethereum/go-ethereum/rlp"
	"github.com/stretchr/testify/assert"
)

func TestRLPMarshalBlockHeader(t *testing.T) {
	table := []struct {
		json string
		rlp  string
	}{
		// old
		{
			json: `{"hash":"0x11b5c88b4e42fcf95cb1454d5de03d7f31fb59f80df1e49c0723f4f86516ef01","parentHash":"0x372e5820b5f6cd0ffe03c27525694daf28da0ab236cbf961e41aa2e24880bcf7","height":"0xf7cf20","miner":"cfx:aamwwx800rcw63n42kbehesuukjdjcnu4ueu84nhp5","deferredStateRoot":"0x1b04a03817a85ed558e660fb1a0b5b9a640acced757903f8f947cbfbca4cee9a","deferredReceiptsRoot":"0x30ce3b69dadfb10545672f166c953825cccfcb2fb2b6c9c3e205ed2d6f9e8ac1","deferredLogsBloomHash":"0x730d2fa11bef8d14e1f35948a6bdbd09e6ec7fb148ebe2fedae76e5af8cb5d4b","blame":"0x0","transactionsRoot":"0x4bbeac6fa3502f7d2e78eed5caec47ffefad6ec5bb85e84d02f682a05b81de14","epochNumber":"0xf7cf20","blockNumber":null,"gasLimit":"0x1c9c380","gasUsed":null,"timestamp":"0x60b853f9","difficulty":"0x1371539f68f","powQuality":"0x1db83607fe3","refereeHashes":[],"adaptive":false,"nonce":"0x11f684c0d194b2a3","size":"0x421","custom":["0x01","0x02"],"posReference":null}`,
			rlp:  `f90203b842307831316235633838623465343266636639356362313435346435646530336437663331666235396638306466316534396330373233663466383635313665663031b84230783337326535383230623566366364306666653033633237353235363934646166323864613061623233366362663936316534316161326532343838306263663783f7cf20f5836366788475736572a200000a1212131e16160d02121c190b1a1809010407040e101009080308020b101a108804101e1a0b070c1bb842307831623034613033383137613835656435353865363630666231613062356239613634306163636564373537393033663866393437636266626361346365653961b842307833306365336236396461646662313035343536373266313636633935333832356363636663623266623262366339633365323035656432643666396538616331b84230783733306432666131316265663864313465316633353934386136626462643039653665633766623134386562653266656461653736653561663863623564346280b84230783462626561633666613335303266376432653738656564356361656334376666656661643665633562623835653834643032663638326130356238316465313483f7cf20c08401c9c380c08460b853f98601371539f68f8601db83607fe3c0808811f684c0d194b2a3820421c2010280`,
		},
		{
			json: `{"hash":"0x11b5c88b4e42fcf95cb1454d5de03d7f31fb59f80df1e49c0723f4f86516ef01","parentHash":"0x372e5820b5f6cd0ffe03c27525694daf28da0ab236cbf961e41aa2e24880bcf7","height":"0xf7cf20","miner":"cfx:aamwwx800rcw63n42kbehesuukjdjcnu4ueu84nhp5","deferredStateRoot":"0x1b04a03817a85ed558e660fb1a0b5b9a640acced757903f8f947cbfbca4cee9a","deferredReceiptsRoot":"0x30ce3b69dadfb10545672f166c953825cccfcb2fb2b6c9c3e205ed2d6f9e8ac1","deferredLogsBloomHash":"0x730d2fa11bef8d14e1f35948a6bdbd09e6ec7fb148ebe2fedae76e5af8cb5d4b","blame":"0x0","transactionsRoot":"0x4bbeac6fa3502f7d2e78eed5caec47ffefad6ec5bb85e84d02f682a05b81de14","epochNumber":"0xf7cf20","blockNumber":"0xf7cf20","gasLimit":"0x1c9c380","gasUsed":"0x4c136","timestamp":"0x60b853f9","difficulty":"0x1371539f68f","powQuality":"0x1db83607fe3","refereeHashes":[],"adaptive":false,"nonce":"0x11f684c0d194b2a3","size":"0x421","custom":["0x0102"],"posReference":null}`,
			rlp:  `f9020cb842307831316235633838623465343266636639356362313435346435646530336437663331666235396638306466316534396330373233663466383635313665663031b84230783337326535383230623566366364306666653033633237353235363934646166323864613061623233366362663936316534316161326532343838306263663783f7cf20f5836366788475736572a200000a1212131e16160d02121c190b1a1809010407040e101009080308020b101a108804101e1a0b070c1bb842307831623034613033383137613835656435353865363630666231613062356239613634306163636564373537393033663866393437636266626361346365653961b842307833306365336236396461646662313035343536373266313636633935333832356363636663623266623262366339633365323035656432643666396538616331b84230783733306432666131316265663864313465316633353934386136626462643039653665633766623134386562653266656461653736653561663863623564346280b84230783462626561633666613335303266376432653738656564356361656334376666656661643665633562623835653834643032663638326130356238316465313483f7cf20c483f7cf208401c9c380c48304c1368460b853f98601371539f68f8601db83607fe3c0808811f684c0d194b2a3820421c382010280`,
		},
		{
			json: `{"hash":"0x11b5c88b4e42fcf95cb1454d5de03d7f31fb59f80df1e49c0723f4f86516ef01","parentHash":"0x372e5820b5f6cd0ffe03c27525694daf28da0ab236cbf961e41aa2e24880bcf7","height":"0xf7cf20","miner":"cfx:aamwwx800rcw63n42kbehesuukjdjcnu4ueu84nhp5","deferredStateRoot":"0x1b04a03817a85ed558e660fb1a0b5b9a640acced757903f8f947cbfbca4cee9a","deferredReceiptsRoot":"0x30ce3b69dadfb10545672f166c953825cccfcb2fb2b6c9c3e205ed2d6f9e8ac1","deferredLogsBloomHash":"0x730d2fa11bef8d14e1f35948a6bdbd09e6ec7fb148ebe2fedae76e5af8cb5d4b","blame":"0x0","transactionsRoot":"0x4bbeac6fa3502f7d2e78eed5caec47ffefad6ec5bb85e84d02f682a05b81de14","epochNumber":"0xf7cf20","blockNumber":"0xf7cf20","gasLimit":"0x1c9c380","gasUsed":"0x4c136","timestamp":"0x60b853f9","difficulty":"0x1371539f68f","powQuality":"0x1db83607fe3","refereeHashes":[],"adaptive":false,"nonce":"0x11f684c0d194b2a3","size":"0x421","custom":[],"posReference":null}`,
			rlp:  `f90209b842307831316235633838623465343266636639356362313435346435646530336437663331666235396638306466316534396330373233663466383635313665663031b84230783337326535383230623566366364306666653033633237353235363934646166323864613061623233366362663936316534316161326532343838306263663783f7cf20f5836366788475736572a200000a1212131e16160d02121c190b1a1809010407040e101009080308020b101a108804101e1a0b070c1bb842307831623034613033383137613835656435353865363630666231613062356239613634306163636564373537393033663866393437636266626361346365653961b842307833306365336236396461646662313035343536373266313636633935333832356363636663623266623262366339633365323035656432643666396538616331b84230783733306432666131316265663864313465316633353934386136626462643039653665633766623134386562653266656461653736653561663863623564346280b84230783462626561633666613335303266376432653738656564356361656334376666656661643665633562623835653834643032663638326130356238316465313483f7cf20c483f7cf208401c9c380c48304c1368460b853f98601371539f68f8601db83607fe3c0808811f684c0d194b2a3820421c080`,
		},
		{
			json: `{"hash":"0x26f15dc6f353485cdfb1b370becc4abfdacbd36e39c3f9f42be724fe4073cfeb","parentHash":"0xa0c5975f77a557ab65eb1a137de52cd9d9a88f4b36add157ec3c0e2edce1351f","height":"0xf7cf1c","miner":"cfx:aamwwx800rcw63n42kbehesuukjdjcnu4ueu84nhp5","deferredStateRoot":"0x085123da2df1ab4d0af41b99396280ea8f7778048f78bc141118ca1b163d0d75","deferredReceiptsRoot":"0x7976c478fc5ae2d2abe95cd7ef488b439fbac961abedf4a1b0cdee4be6bab27e","deferredLogsBloomHash":"0xd397b3b043d87fcd6fad1291ff0bfd16401c274896d8c63a923727f077b8e0b5","blame":"0x0","transactionsRoot":"0xbf9add52641cdeb9fec7fc8bbacfaf71592c37df34b1f36220003af8797dfb41","epochNumber":"0xf7cf1c","blockNumber":"0xf7cf1c","gasLimit":"0x1c9c380","gasUsed":"0x2ef98","timestamp":"0x60b853f5","difficulty":"0x1371539f68f","powQuality":"0x204fb171a2c","refereeHashes":["0xd28aeb7aea7012a58d776b89f03bbed85d7ebd75e445323e02dcf28af8753750","0xa20f6152fb3434c0c1c3ce8176044476e4baa2db18d0cea9185932e7072fd0ac"],"adaptive":false,"nonce":"0xf1c5c1596190023b","size":"0x24a","custom":[],"posReference":null}`,
			rlp:  `f90292b842307832366631356463366633353334383563646662316233373062656363346162666461636264333665333963336639663432626537323466653430373363666562b84230786130633539373566373761353537616236356562316131333764653532636439643961383866346233366164643135376563336330653265646365313335316683f7cf1cf5836366788475736572a200000a1212131e16160d02121c190b1a1809010407040e101009080308020b101a108804101e1a0b070c1bb842307830383531323364613264663161623464306166343162393933393632383065613866373737383034386637386263313431313138636131623136336430643735b842307837393736633437386663356165326432616265393563643765663438386234333966626163393631616265646634613162306364656534626536626162323765b84230786433393762336230343364383766636436666164313239316666306266643136343031633237343839366438633633613932333732376630373762386530623580b84230786266396164643532363431636465623966656337666338626261636661663731353932633337646633346231663336323230303033616638373937646662343183f7cf1cc483f7cf1c8401c9c380c48302ef988460b853f58601371539f68f860204fb171a2cf888b842307864323861656237616561373031326135386437373662383966303362626564383564376562643735653434353332336530326463663238616638373533373530b8423078613230663631353266623334333463306331633363653831373630343434373665346261613264623138643063656139313835393332653730373266643061638088f1c5c1596190023b82024ac080`,
		},
		// 1559
		{
			json: `{"hash":"0x7fab5518a46d13a4d8b5c32d953872f41225a6bd5876781e97b094ef3ff03d4f","parentHash":"0xdda233f61d4c2b6b1526831bf9cd48144c3032cd864ca2779c329760edd6a283","height":"0x14e997","miner":"net8888:aajaaaaaaaaaaaaaaaaaaaaaaaaaaaaabux08ucy6f","deferredStateRoot":"0xaed49a6fe6bfb3c98d8b767080161590ed08e516a10b26b7fbe5b3a6f86038bf","deferredReceiptsRoot":"0x09f8709ea9f344a810811a373b30861568f5686e649d6177fd92ea2db7477508","deferredLogsBloomHash":"0xd397b3b043d87fcd6fad1291ff0bfd16401c274896d8c63a923727f077b8e0b5","blame":"0x0","transactionsRoot":"0x32c3c4f7d6b706cd4bdb158a58b441a6bf05847dfe33edf78b7cd2f708197805","epochNumber":"0x14e997","blockNumber":"0x178335","gasLimit":"0x3938700","gasUsed":"0x62d4","baseFeePerGas":"0x3b9aca00","timestamp":"0x66690a60","difficulty":"0x2cf","powQuality":"0x565","refereeHashes":[],"adaptive":false,"nonce":"0x659c4c09269d4b2c","size":"0xb4","custom":["0x04"],"posReference":"0x181c59f93232a2dca79123f3f23396920ec779516f6b86f0e94a84e7803588e0"}`,
			rlp:  `f9024db842307837666162353531386134366431336134643862356333326439353338373266343132323561366264353837363738316539376230393465663366663033643466b8423078646461323333663631643463326236623135323638333162663963643438313434633330333263643836346361323737396333323937363065646436613238338314e997f839876e6574383838388475736572a2000008000000000000000000000000000000000000000000000000000000000001108813161e1002141c05b842307861656434396136666536626662336339386438623736373038303136313539306564303865353136613130623236623766626535623361366638363033386266b842307830396638373039656139663334346138313038313161333733623330383631353638663536383665363439643631373766643932656132646237343737353038b84230786433393762336230343364383766636436666164313239316666306266643136343031633237343839366438633633613932333732376630373762386530623580b8423078333263336334663764366237303663643462646231353861353862343431613662663035383437646665333365646637386237636432663730383139373830358314e997c4831783358403938700c38262d4843b9aca008466690a608202cf820565c08088659c4c09269d4b2c81b4c104b842307831383163353966393332333261326463613739313233663366323333393639323065633737393531366636623836663065393461383465373830333538386530`,
		},
	}

	t.Run("Encode", func(t *testing.T) {
		for i, item := range table {
			// Encode
			var bh BlockHeader
			err := utils.JsonUnmarshal([]byte(item.json), &bh)
			assert.NoError(t, err, i)

			rlpEncoded, err := rlp.EncodeToBytes(bh)
			assert.NoError(t, err, i)

			assert.Equal(t, item.rlp, hex.EncodeToString(rlpEncoded), i)
		}
	})

	t.Run("Decode", func(t *testing.T) {
		for _, item := range table {
			// Decode
			var bh BlockHeader
			dBytes, err := hex.DecodeString(item.rlp)
			assert.NoError(t, err)

			err = rlp.DecodeBytes(dBytes, &bh)
			assert.NoError(t, err)

			j, err := utils.JsonMarshal(bh)
			assert.NoError(t, err)

			assert.Equal(t, item.json, string(j))
		}
	})
}

func TestRLPMarshalBlock(t *testing.T) {
	table := []struct {
		json string
		rlp  string
	}{
		{
			json: `{"hash":"0x26f15dc6f353485cdfb1b370becc4abfdacbd36e39c3f9f42be724fe4073cfeb","parentHash":"0xa0c5975f77a557ab65eb1a137de52cd9d9a88f4b36add157ec3c0e2edce1351f","height":"0xf7cf1c","miner":"cfx:aamwwx800rcw63n42kbehesuukjdjcnu4ueu84nhp5","deferredStateRoot":"0x085123da2df1ab4d0af41b99396280ea8f7778048f78bc141118ca1b163d0d75","deferredReceiptsRoot":"0x7976c478fc5ae2d2abe95cd7ef488b439fbac961abedf4a1b0cdee4be6bab27e","deferredLogsBloomHash":"0xd397b3b043d87fcd6fad1291ff0bfd16401c274896d8c63a923727f077b8e0b5","blame":"0x0","transactionsRoot":"0xbf9add52641cdeb9fec7fc8bbacfaf71592c37df34b1f36220003af8797dfb41","epochNumber":"0xf7cf1c","blockNumber":"0xf7cf20","gasLimit":"0x1c9c380","gasUsed":"0x2ef98","timestamp":"0x60b853f5","difficulty":"0x1371539f68f","powQuality":"0x204fb171a2c","refereeHashes":["0xd28aeb7aea7012a58d776b89f03bbed85d7ebd75e445323e02dcf28af8753750","0xa20f6152fb3434c0c1c3ce8176044476e4baa2db18d0cea9185932e7072fd0ac"],"adaptive":false,"nonce":"0xf1c5c1596190023b","size":"0x24a","custom":["0x0102","0x0203"],"posReference":null,"transactions":[{"type":"0x0","hash":"0x740b71de5591fe87bf661d5c4a39cf2a1fbf8cf21b68928033a7382154c78d19","nonce":"0xe033d","blockHash":"0x26f15dc6f353485cdfb1b370becc4abfdacbd36e39c3f9f42be724fe4073cfeb","transactionIndex":"0x0","from":"cfx:aapkcjr28dg976fzr43c5hf1rwn5xv8t1uy4r2yyeu","to":"cfx:aan4cta4wa1av51anm00844cg01hf19zw2vufsvk4n","value":"0x3bd913e6c1df4000","gasPrice":"0xa","gas":"0x5208","contractCreated":null,"data":"0x","storageLimit":"0x0","epochHeight":"0xf7cf19","chainId":"0x405","status":"0x0","v":"0x0","r":"0x57199fc1aced9c518fb8f2a31978c434fd280173602f38002b7252c02573cb00","s":"0x3d0ef3327d226d46ed0a53aa4f5486666aab2a9423a8261b9456975ba1fde346"},{"type":"0x0","hash":"0x536cb069dc9024625c3ae27fef0a32df6733bec0a159f1b4871741b73b0419cb","nonce":"0xe033e","blockHash":"0x26f15dc6f353485cdfb1b370becc4abfdacbd36e39c3f9f42be724fe4073cfeb","transactionIndex":"0x1","from":"cfx:aapkcjr28dg976fzr43c5hf1rwn5xv8t1uy4r2yyeu","to":"cfx:aam9ee2tdeajz4akcx3nyhgnmu7zw5hd2u0nnce7j5","value":"0x3ab4b07cc8db8000","gasPrice":"0xa","gas":"0x5208","contractCreated":null,"data":"0x","storageLimit":"0x0","epochHeight":"0xf7cf19","chainId":"0x405","status":"0x0","v":"0x0","r":"0x7b5ff9bb9a93bf9d974102a22a6323c86558c1cc776ad93af5f2f1df0f1c9918","s":"0x6aaddd6e3c988bd6b02b37cd8f211a26f6ecd759fb8744f5233a3dfcd2d10183"},{"type":"0x0","hash":"0x18e0f546df2f56e8149bb9424d70201feb41f8e2ea7c1a850a03b8a2f508a8f7","nonce":"0x1063","blockHash":"0x26f15dc6f353485cdfb1b370becc4abfdacbd36e39c3f9f42be724fe4073cfeb","transactionIndex":"0x2","from":"cfx:aakycdtv194ws11y73tsam7va08ex0ztmjrjaxuds3","to":"cfx:acam64yj323zd4t1fhybxh3jsg7hu4012yz9kakxs9","value":"0x3635c9adc5dea00000","gasPrice":"0x1","gas":"0x28e04","contractCreated":null,"data":"0x5c350838000000000000000000000000000000000000000000000017931cda8bd511fb00000000000000000000000000000000000000000000000000000000000000008000000000000000000000000013410df1bff5275ef4ee5ee02bb105bc49daaf520000000000000000000000000000000000000000000000000000000060b9a56e00000000000000000000000000000000000000000000000000000000000000020000000000000000000000008d7df9316faa0586e175b5e6d03c6bda76e3d9500000000000000000000000008b8689c7f3014a4d86e4d1d0daaf74a47f5e0f27","storageLimit":"0x1cc","epochHeight":"0xf7cf19","chainId":"0x405","status":"0x0","v":"0x0","r":"0x2e2237b2baf72e80725d0cbd5aee2dd755a606c905e77e45883b2ed8998523ab","s":"0x3f3be41bbfab7d4aca6d8c45887882f61b2ed0cc8f00a4ab2ab197eaad2a8c70"}]}`,
			rlp:  `f9087bf90298b842307832366631356463366633353334383563646662316233373062656363346162666461636264333665333963336639663432626537323466653430373363666562b84230786130633539373566373761353537616236356562316131333764653532636439643961383866346233366164643135376563336330653265646365313335316683f7cf1cf5836366788475736572a200000a1212131e16160d02121c190b1a1809010407040e101009080308020b101a108804101e1a0b070c1bb842307830383531323364613264663161623464306166343162393933393632383065613866373737383034386637386263313431313138636131623136336430643735b842307837393736633437386663356165326432616265393563643765663438386234333966626163393631616265646634613162306364656534626536626162323765b84230786433393762336230343364383766636436666164313239316666306266643136343031633237343839366438633633613932333732376630373762386530623580b84230786266396164643532363431636465623966656337666338626261636661663731353932633337646633346231663336323230303033616638373937646662343183f7cf1cc483f7cf208401c9c380c48302ef988460b853f58601371539f68f860204fb171a2cf888b842307864323861656237616561373031326135386437373662383966303362626564383564376562643735653434353332336530326463663238616638373533373530b8423078613230663631353266623334333463306331633363653831373630343434373665346261613264623138643063656139313835393332653730373266643061638088f1c5c1596190023b82024ac682010282020380f905ddf90156b842307837343062373164653535393166653837626636363164356334613339636632613166626638636632316236383932383033336137333832313534633738643139830e033db84230783236663135646336663335333438356364666231623337306265636334616266646163626433366533396333663966343262653732346665343037336366656280f5836366788475736572a200000c0902080d181e03061f1d1c05150d1a19021b0705170d120b1b13111e0f171088141a0d1814140410f5836366788475736572a200000b1a020f001a12001700111b17000b0a16161e1a1a020616170705171f151218881110050e11091a0b883bd913e6c1df40000a825208c08230788083f7cf198204058080a057199fc1aced9c518fb8f2a31978c434fd280173602f38002b7252c02573cb00a03d0ef3327d226d46ed0a53aa4f5486666aab2a9423a8261b9456975ba1fde346f90156b842307835333663623036396463393032343632356333616532376665663061333264663637333362656330613135396631623438373137343162373362303431396362830e033eb84230783236663135646336663335333438356364666231623337306265636334616266646163626433366533396333663966343262653732346665343037336366656201f5836366788475736572a200000c0902080d181e03061f1d1c05150d1a19021b0705170d120b1b13111e0f171088141a0d1814140410f5836366788475736572a200000a1f0404180f03040008151a00090213190b1407060b0a101d15121b0703181088160b0b02041d081b883ab4b07cc8db80000a825208c08230788083f7cf198204058080a07b5ff9bb9a93bf9d974102a22a6323c86558c1cc776ad93af5f2f1df0f1c9918a06aaddd6e3c988bd6b02b37cd8f211a26f6ecd759fb8744f5233a3dfcd2d10183f90328b842307831386530663534366466326635366538313439626239343234643730323031666562343166386532656137633161383530613033623861326635303861386637821063b84230783236663135646336663335333438356364666231623337306265636334616266646163626433366533396333663966343262653732346665343037336366656202f5836366788475736572a20000091402030f11171f1a120e1717141d190f0e000a1d1100161e041316150f0a08880d08001310030e19f8398363667888636f6e7472616374a20002000a1c1a140819181915031a0f1705071401130719080e061d07101a1617181488151f090009130e1f893635c9adc5dea000000183028e04c0b901ca30783563333530383338303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303137393331636461386264353131666230303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030383030303030303030303030303030303030303030303030303031333431306466316266663532373565663465653565653032626231303562633439646161663532303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303036306239613536653030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303230303030303030303030303030303030303030303030303038643764663933313666616130353836653137356235653664303363366264613736653364393530303030303030303030303030303030303030303030303030386238363839633766333031346134643836653464316430646161663734613437663565306632378201cc83f7cf198204058080a02e2237b2baf72e80725d0cbd5aee2dd755a606c905e77e45883b2ed8998523aba03f3be41bbfab7d4aca6d8c45887882f61b2ed0cc8f00a4ab2ab197eaad2a8c70`,
		},
		{
			json: `{"hash":"0x26f15dc6f353485cdfb1b370becc4abfdacbd36e39c3f9f42be724fe4073cfeb","parentHash":"0xa0c5975f77a557ab65eb1a137de52cd9d9a88f4b36add157ec3c0e2edce1351f","height":"0xf7cf1c","miner":"cfx:aamwwx800rcw63n42kbehesuukjdjcnu4ueu84nhp5","deferredStateRoot":"0x085123da2df1ab4d0af41b99396280ea8f7778048f78bc141118ca1b163d0d75","deferredReceiptsRoot":"0x7976c478fc5ae2d2abe95cd7ef488b439fbac961abedf4a1b0cdee4be6bab27e","deferredLogsBloomHash":"0xd397b3b043d87fcd6fad1291ff0bfd16401c274896d8c63a923727f077b8e0b5","blame":"0x0","transactionsRoot":"0xbf9add52641cdeb9fec7fc8bbacfaf71592c37df34b1f36220003af8797dfb41","epochNumber":"0xf7cf1c","blockNumber":"0xf7cf20","gasLimit":"0x1c9c380","gasUsed":"0x2ef98","timestamp":"0x60b853f5","difficulty":"0x1371539f68f","powQuality":"0x204fb171a2c","refereeHashes":["0xd28aeb7aea7012a58d776b89f03bbed85d7ebd75e445323e02dcf28af8753750","0xa20f6152fb3434c0c1c3ce8176044476e4baa2db18d0cea9185932e7072fd0ac"],"adaptive":false,"nonce":"0xf1c5c1596190023b","size":"0x24a","custom":[],"posReference":null,"transactions":[{"type":"0x0","hash":"0x740b71de5591fe87bf661d5c4a39cf2a1fbf8cf21b68928033a7382154c78d19","nonce":"0xe033d","blockHash":"0x26f15dc6f353485cdfb1b370becc4abfdacbd36e39c3f9f42be724fe4073cfeb","transactionIndex":"0x0","from":"cfx:aapkcjr28dg976fzr43c5hf1rwn5xv8t1uy4r2yyeu","to":"cfx:aan4cta4wa1av51anm00844cg01hf19zw2vufsvk4n","value":"0x3bd913e6c1df4000","gasPrice":"0xa","gas":"0x5208","contractCreated":null,"data":"0x","storageLimit":"0x0","epochHeight":"0xf7cf19","chainId":"0x405","status":"0x0","v":"0x0","r":"0x57199fc1aced9c518fb8f2a31978c434fd280173602f38002b7252c02573cb00","s":"0x3d0ef3327d226d46ed0a53aa4f5486666aab2a9423a8261b9456975ba1fde346"},{"type":"0x0","hash":"0x536cb069dc9024625c3ae27fef0a32df6733bec0a159f1b4871741b73b0419cb","nonce":"0xe033e","blockHash":"0x26f15dc6f353485cdfb1b370becc4abfdacbd36e39c3f9f42be724fe4073cfeb","transactionIndex":"0x1","from":"cfx:aapkcjr28dg976fzr43c5hf1rwn5xv8t1uy4r2yyeu","to":"cfx:aam9ee2tdeajz4akcx3nyhgnmu7zw5hd2u0nnce7j5","value":"0x3ab4b07cc8db8000","gasPrice":"0xa","gas":"0x5208","contractCreated":null,"data":"0x","storageLimit":"0x0","epochHeight":"0xf7cf19","chainId":"0x405","status":"0x0","v":"0x0","r":"0x7b5ff9bb9a93bf9d974102a22a6323c86558c1cc776ad93af5f2f1df0f1c9918","s":"0x6aaddd6e3c988bd6b02b37cd8f211a26f6ecd759fb8744f5233a3dfcd2d10183"},{"type":"0x0","hash":"0x18e0f546df2f56e8149bb9424d70201feb41f8e2ea7c1a850a03b8a2f508a8f7","nonce":"0x1063","blockHash":"0x26f15dc6f353485cdfb1b370becc4abfdacbd36e39c3f9f42be724fe4073cfeb","transactionIndex":"0x2","from":"cfx:aakycdtv194ws11y73tsam7va08ex0ztmjrjaxuds3","to":"cfx:acam64yj323zd4t1fhybxh3jsg7hu4012yz9kakxs9","value":"0x3635c9adc5dea00000","gasPrice":"0x1","gas":"0x28e04","contractCreated":null,"data":"0x5c350838000000000000000000000000000000000000000000000017931cda8bd511fb00000000000000000000000000000000000000000000000000000000000000008000000000000000000000000013410df1bff5275ef4ee5ee02bb105bc49daaf520000000000000000000000000000000000000000000000000000000060b9a56e00000000000000000000000000000000000000000000000000000000000000020000000000000000000000008d7df9316faa0586e175b5e6d03c6bda76e3d9500000000000000000000000008b8689c7f3014a4d86e4d1d0daaf74a47f5e0f27","storageLimit":"0x1cc","epochHeight":"0xf7cf19","chainId":"0x405","status":"0x0","v":"0x0","r":"0x2e2237b2baf72e80725d0cbd5aee2dd755a606c905e77e45883b2ed8998523ab","s":"0x3f3be41bbfab7d4aca6d8c45887882f61b2ed0cc8f00a4ab2ab197eaad2a8c70"}]}`,
			rlp:  `f90875f90292b842307832366631356463366633353334383563646662316233373062656363346162666461636264333665333963336639663432626537323466653430373363666562b84230786130633539373566373761353537616236356562316131333764653532636439643961383866346233366164643135376563336330653265646365313335316683f7cf1cf5836366788475736572a200000a1212131e16160d02121c190b1a1809010407040e101009080308020b101a108804101e1a0b070c1bb842307830383531323364613264663161623464306166343162393933393632383065613866373737383034386637386263313431313138636131623136336430643735b842307837393736633437386663356165326432616265393563643765663438386234333966626163393631616265646634613162306364656534626536626162323765b84230786433393762336230343364383766636436666164313239316666306266643136343031633237343839366438633633613932333732376630373762386530623580b84230786266396164643532363431636465623966656337666338626261636661663731353932633337646633346231663336323230303033616638373937646662343183f7cf1cc483f7cf208401c9c380c48302ef988460b853f58601371539f68f860204fb171a2cf888b842307864323861656237616561373031326135386437373662383966303362626564383564376562643735653434353332336530326463663238616638373533373530b8423078613230663631353266623334333463306331633363653831373630343434373665346261613264623138643063656139313835393332653730373266643061638088f1c5c1596190023b82024ac080f905ddf90156b842307837343062373164653535393166653837626636363164356334613339636632613166626638636632316236383932383033336137333832313534633738643139830e033db84230783236663135646336663335333438356364666231623337306265636334616266646163626433366533396333663966343262653732346665343037336366656280f5836366788475736572a200000c0902080d181e03061f1d1c05150d1a19021b0705170d120b1b13111e0f171088141a0d1814140410f5836366788475736572a200000b1a020f001a12001700111b17000b0a16161e1a1a020616170705171f151218881110050e11091a0b883bd913e6c1df40000a825208c08230788083f7cf198204058080a057199fc1aced9c518fb8f2a31978c434fd280173602f38002b7252c02573cb00a03d0ef3327d226d46ed0a53aa4f5486666aab2a9423a8261b9456975ba1fde346f90156b842307835333663623036396463393032343632356333616532376665663061333264663637333362656330613135396631623438373137343162373362303431396362830e033eb84230783236663135646336663335333438356364666231623337306265636334616266646163626433366533396333663966343262653732346665343037336366656201f5836366788475736572a200000c0902080d181e03061f1d1c05150d1a19021b0705170d120b1b13111e0f171088141a0d1814140410f5836366788475736572a200000a1f0404180f03040008151a00090213190b1407060b0a101d15121b0703181088160b0b02041d081b883ab4b07cc8db80000a825208c08230788083f7cf198204058080a07b5ff9bb9a93bf9d974102a22a6323c86558c1cc776ad93af5f2f1df0f1c9918a06aaddd6e3c988bd6b02b37cd8f211a26f6ecd759fb8744f5233a3dfcd2d10183f90328b842307831386530663534366466326635366538313439626239343234643730323031666562343166386532656137633161383530613033623861326635303861386637821063b84230783236663135646336663335333438356364666231623337306265636334616266646163626433366533396333663966343262653732346665343037336366656202f5836366788475736572a20000091402030f11171f1a120e1717141d190f0e000a1d1100161e041316150f0a08880d08001310030e19f8398363667888636f6e7472616374a20002000a1c1a140819181915031a0f1705071401130719080e061d07101a1617181488151f090009130e1f893635c9adc5dea000000183028e04c0b901ca30783563333530383338303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303137393331636461386264353131666230303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030383030303030303030303030303030303030303030303030303031333431306466316266663532373565663465653565653032626231303562633439646161663532303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303036306239613536653030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303230303030303030303030303030303030303030303030303038643764663933313666616130353836653137356235653664303363366264613736653364393530303030303030303030303030303030303030303030303030386238363839633766333031346134643836653464316430646161663734613437663565306632378201cc83f7cf198204058080a02e2237b2baf72e80725d0cbd5aee2dd755a606c905e77e45883b2ed8998523aba03f3be41bbfab7d4aca6d8c45887882f61b2ed0cc8f00a4ab2ab197eaad2a8c70`,
		},
		{
			json: `{"hash":"0xa6528367a9287ed3a66fc64457db15e2aaa93104a3fd06d4f0a2beb6cc1f26c8","parentHash":"0x5aef321e4e49f430ad6322af8a0133eae83e635f7893c996eb127dcf24a00b14","height":"0x792776","miner":"cfx:aatxetsp0kdarpdb5stdyex11dr3x6sb0jw2gykec0","deferredStateRoot":"0xa979a8c492c44a512aa9529911a7862e1b61ce2aa441645e865def9219d2c68b","deferredReceiptsRoot":"0xd5f7e7960e9b56753868260c280746c01353dcd1b91a20cee2c919d0dc7bf78b","deferredLogsBloomHash":"0xd397b3b043d87fcd6fad1291ff0bfd16401c274896d8c63a923727f077b8e0b5","blame":"0x0","transactionsRoot":"0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470","epochNumber":"0x792778","blockNumber":"0xf7cf1c","gasLimit":"0x1c9c380","gasUsed":"0x0","timestamp":"0x6026478e","difficulty":"0xa8b175a4dc","powQuality":"0x2223e36adc5","refereeHashes":["0x4e4fca2593068b1dc83ecae3c1eaf0e4d41623985fd03d7f15fc1d63f653e7d2"],"adaptive":false,"nonce":"0x209fc5fbe719dace","size":"0x0","custom":[],"posReference":null,"transactions":[]}`,
			rlp:  `f9024cf90248b842307861363532383336376139323837656433613636666336343435376462313565326161613933313034613366643036643466306132626562366363316632366338b84230783561656633323165346534396634333061643633323261663861303133336561653833653633356637383933633939366562313237646366323461303062313483792776f5836366788475736572a200000f13040f0e0c160903000d0c03011b0e0f031404131717030d19131c0e011608881218061409040216b842307861393739613863343932633434613531326161393532393931316137383632653162363163653261613434313634356538363564656639323139643263363862b842307864356637653739363065396235363735333836383236306332383037343663303133353364636431623931613230636565326339313964306463376266373862b84230786433393762336230343364383766636436666164313239316666306266643136343031633237343839366438633633613932333732376630373762386530623580b84230786335643234363031383666373233336339323765376462326463633730336330653530306236353363613832323733623762666164383034356438356134373083792778c483f7cf1c8401c9c380c180846026478e85a8b175a4dc8602223e36adc5f844b8423078346534666361323539333036386231646338336563616533633165616630653464343136323339383566643033643766313566633164363366363533653764328088209fc5fbe719dace80c080c0`,
		},
		// 1559
		{
			json: `{"hash":"0x7fab5518a46d13a4d8b5c32d953872f41225a6bd5876781e97b094ef3ff03d4f","parentHash":"0xdda233f61d4c2b6b1526831bf9cd48144c3032cd864ca2779c329760edd6a283","height":"0x14e997","miner":"net8888:aajaaaaaaaaaaaaaaaaaaaaaaaaaaaaabux08ucy6f","deferredStateRoot":"0xaed49a6fe6bfb3c98d8b767080161590ed08e516a10b26b7fbe5b3a6f86038bf","deferredReceiptsRoot":"0x09f8709ea9f344a810811a373b30861568f5686e649d6177fd92ea2db7477508","deferredLogsBloomHash":"0xd397b3b043d87fcd6fad1291ff0bfd16401c274896d8c63a923727f077b8e0b5","blame":"0x0","transactionsRoot":"0x32c3c4f7d6b706cd4bdb158a58b441a6bf05847dfe33edf78b7cd2f708197805","epochNumber":"0x14e997","blockNumber":"0x178335","gasLimit":"0x3938700","gasUsed":"0x62d4","baseFeePerGas":"0x3b9aca00","timestamp":"0x66690a60","difficulty":"0x2cf","powQuality":"0x565","refereeHashes":[],"adaptive":false,"nonce":"0x659c4c09269d4b2c","size":"0xb4","custom":["0x04"],"posReference":"0x181c59f93232a2dca79123f3f23396920ec779516f6b86f0e94a84e7803588e0","transactions":[{"accessList":[{"address":"net8888:aamxnf2v91t8e9dabh5d3humnyxp28hrju94f55s67","storageKeys":["0x0000000000000000000000000000000000000000000000000000000000000000"]}],"type":"0x2","hash":"0x79bc3f80eebc0c367c0d8749eb5134c6c0523477b92cbde9d2b36b9f1402a216","nonce":"0x11","blockHash":"0x7fab5518a46d13a4d8b5c32d953872f41225a6bd5876781e97b094ef3ff03d4f","transactionIndex":"0x0","from":"net8888:aamxnf2v91t8e9dabh5d3humnyxp28hrju94f55s67","to":"net8888:aamxnf2v91t8e9dabh5d3humnyxp28hrju94f55s67","value":"0x0","gasPrice":"0x779b4daa","gas":"0x62d4","contractCreated":null,"data":"0x","storageLimit":"0x0","epochHeight":"0x14e991","chainId":"0x22b8","status":"0x0","maxPriorityFeePerGas":"0x779b4daa","maxFeePerGas":"0x779b4daa","v":"0x0","r":"0x56f0775d2293088208e0cb8d39f53a632014f9516f233998cd0b0f08fd8dc48b","s":"0x6a17392338f6acc8df76eaabb3ab8ca876ea965cec40d4ddfdf14fbc0dd7df41"}]}`,
			rlp:  `f90421f9024db842307837666162353531386134366431336134643862356333326439353338373266343132323561366264353837363738316539376230393465663366663033643466b8423078646461323333663631643463326236623135323638333162663963643438313434633330333263643836346361323737396333323937363065646436613238338314e997f839876e6574383838388475736572a2000008000000000000000000000000000000000000000000000000000000000001108813161e1002141c05b842307861656434396136666536626662336339386438623736373038303136313539306564303865353136613130623236623766626535623361366638363033386266b842307830396638373039656139663334346138313038313161333733623330383631353638663536383665363439643631373766643932656132646237343737353038b84230786433393762336230343364383766636436666164313239316666306266643136343031633237343839366438633633613932333732376630373762386530623580b8423078333263336334663764366237303663643462646231353861353862343431613662663035383437646665333365646637386237636432663730383139373830358314e997c4831783358403938700c38262d4843b9aca008466690a608202cf820565c08088659c4c09269d4b2c81b4c104b842307831383163353966393332333261326463613739313233663366323333393639323065633737393531366636623836663065393461383465373830333538386530f901ce8363667802f901c602b84230783739626333663830656562633063333637633064383734396562353133346336633035323334373762393263626465396432623336623966313430326132313611b84230783766616235353138613436643133613464386235633332643935333837326634313232356136626435383736373831653937623039346566336666303364346680f839876e6574383838388475736572a200000a130b0518111f170f1e041f030001071b031907100a0b14130c181e070d0810881f1a051b1b0e1c1df839876e6574383838388475736572a200000a130b0518111f170f1e041f030001071b031907100a0b14130c181e070d0810881f1a051b1b0e1c1d808262d484779b4daac0823078808314e9918222b880f85ff85df839876e6574383838388475736572a200000a130b0518111f170f1e041f030001071b031907100a0b14130c181e070d0810881f1a051b1b0e1c1de1a0000000000000000000000000000000000000000000000000000000000000000084779b4daa84779b4daa80a056f0775d2293088208e0cb8d39f53a632014f9516f233998cd0b0f08fd8dc48ba06a17392338f6acc8df76eaabb3ab8ca876ea965cec40d4ddfdf14fbc0dd7df4180`,
		},
	}

	t.Run("Encode", func(t *testing.T) {
		for _, item := range table {
			// Encode
			var b Block
			err := utils.JsonUnmarshal([]byte(item.json), &b)
			assert.NoError(t, err)

			rlpEncoded, err := rlp.EncodeToBytes(b)
			assert.NoError(t, err)

			assert.Equal(t, item.rlp, hex.EncodeToString(rlpEncoded))
		}
	})

	t.Run("Decode", func(t *testing.T) {
		for _, item := range table {
			// Decode
			var b Block
			dBytes, err := hex.DecodeString(item.rlp)
			assert.NoError(t, err)

			err = rlp.DecodeBytes(dBytes, &b)
			assert.NoError(t, err)

			j, err := utils.JsonMarshal(b)
			assert.NoError(t, err)

			assert.Equal(t, item.json, string(j))
		}
	})
}

func TestRLPMarshalBlockSummary(t *testing.T) {

	table := []struct {
		json string
		rlp  string
	}{
		{
			json: `{"hash":"0xf2855662d53e36d32bece4e8a3ac7bd8368dd721c8b3f1749fcabc0d1c25d698","parentHash":"0xf31040dd3e47210a6efc006f75e6517dc602597b20328b4ef2310a9b0efeb005","height":"0x79279d","miner":"cfx:aamwwx800rcw63n42kbehesuukjdjcnu4ueu84nhp5","deferredStateRoot":"0xb60444c84c14210b127e9c50a6df7de0c64f318d39950d6b90535f12576909d8","deferredReceiptsRoot":"0xb5ebf9aa3f401b3d1c189bffd746ca2819bafb623fe853c1d3b7eb219de01929","deferredLogsBloomHash":"0x57c769a4c976741eb0702f31f8be891c3d1a7415dd18999d6f93d38d0768d34a","blame":"0x0","transactionsRoot":"0x45ed3eda85877aa9f7fdf18808db522b6303c2a5e35ce5c565583e6d52790ec0","epochNumber":"0x79279d","blockNumber":"0xf7cf20","gasLimit":"0x1c9c380","gasUsed":"0x42c22","timestamp":"0x602647d5","difficulty":"0xa8b175a4dc","powQuality":"0x117dfd6ba32","refereeHashes":[],"adaptive":false,"nonce":"0x8995446ca72b2d56","size":"0x47d","custom":["0x01","0x0203"],"posReference":null,"transactions":["0xbc75e11b03eec00d1129134af9e568e4687b53d1d80aaa745bbeb77bbb5c6ab0","0x2f1b8dde4bffb052c70ee082404171cf2399aeee8e46f09cc58d44d4b47ef84c","0x4af03a966b291eb344044fa513f1060bc1ca7f5ec170819044973c95bc7b584f","0x689ae502a41ebeff360549cea025b556a6fe160dd7dd49d9646895cf0697e33e"]}`,
			rlp:  `f90322f9020cb842307866323835353636326435336533366433326265636534653861336163376264383336386464373231633862336631373439666361626330643163323564363938b8423078663331303430646433653437323130613665666330303666373565363531376463363032353937623230333238623465663233313061396230656665623030358379279df5836366788475736572a200000a1212131e16160d02121c190b1a1809010407040e101009080308020b101a108804101e1a0b070c1bb842307862363034343463383463313432313062313237653963353061366466376465306336346633313864333939353064366239303533356631323537363930396438b842307862356562663961613366343031623364316331383962666664373436636132383139626166623632336665383533633164336237656232313964653031393239b84230783537633736396134633937363734316562303730326633316638626538393163336431613734313564643138393939643666393364333864303736386433346180b8423078343565643365646138353837376161396637666466313838303864623532326236333033633261356533356365356335363535383365366435323739306563308379279dc483f7cf208401c9c380c483042c2284602647d585a8b175a4dc860117dfd6ba32c080888995446ca72b2d5682047dc40182020380f90110b842307862633735653131623033656563303064313132393133346166396535363865343638376235336431643830616161373435626265623737626262356336616230b842307832663162386464653462666662303532633730656530383234303431373163663233393961656565386534366630396363353864343464346234376566383463b842307834616630336139363662323931656233343430343466613531336631303630626331636137663565633137303831393034343937336339356263376235383466b842307836383961653530326134316562656666333630353439636561303235623535366136666531363064643764643439643936343638393563663036393765333365`},
		{
			json: `{"hash":"0xf2855662d53e36d32bece4e8a3ac7bd8368dd721c8b3f1749fcabc0d1c25d698","parentHash":"0xf31040dd3e47210a6efc006f75e6517dc602597b20328b4ef2310a9b0efeb005","height":"0x79279d","miner":"cfx:aamwwx800rcw63n42kbehesuukjdjcnu4ueu84nhp5","deferredStateRoot":"0xb60444c84c14210b127e9c50a6df7de0c64f318d39950d6b90535f12576909d8","deferredReceiptsRoot":"0xb5ebf9aa3f401b3d1c189bffd746ca2819bafb623fe853c1d3b7eb219de01929","deferredLogsBloomHash":"0x57c769a4c976741eb0702f31f8be891c3d1a7415dd18999d6f93d38d0768d34a","blame":"0x0","transactionsRoot":"0x45ed3eda85877aa9f7fdf18808db522b6303c2a5e35ce5c565583e6d52790ec0","epochNumber":"0x79279d","blockNumber":"0xf7cf20","gasLimit":"0x1c9c380","gasUsed":"0x42c22","timestamp":"0x602647d5","difficulty":"0xa8b175a4dc","powQuality":"0x117dfd6ba32","refereeHashes":[],"adaptive":false,"nonce":"0x8995446ca72b2d56","size":"0x47d","custom":[],"posReference":null,"transactions":["0xbc75e11b03eec00d1129134af9e568e4687b53d1d80aaa745bbeb77bbb5c6ab0","0x2f1b8dde4bffb052c70ee082404171cf2399aeee8e46f09cc58d44d4b47ef84c","0x4af03a966b291eb344044fa513f1060bc1ca7f5ec170819044973c95bc7b584f","0x689ae502a41ebeff360549cea025b556a6fe160dd7dd49d9646895cf0697e33e"]}`,
			rlp:  `f9031ef90208b842307866323835353636326435336533366433326265636534653861336163376264383336386464373231633862336631373439666361626330643163323564363938b8423078663331303430646433653437323130613665666330303666373565363531376463363032353937623230333238623465663233313061396230656665623030358379279df5836366788475736572a200000a1212131e16160d02121c190b1a1809010407040e101009080308020b101a108804101e1a0b070c1bb842307862363034343463383463313432313062313237653963353061366466376465306336346633313864333939353064366239303533356631323537363930396438b842307862356562663961613366343031623364316331383962666664373436636132383139626166623632336665383533633164336237656232313964653031393239b84230783537633736396134633937363734316562303730326633316638626538393163336431613734313564643138393939643666393364333864303736386433346180b8423078343565643365646138353837376161396637666466313838303864623532326236333033633261356533356365356335363535383365366435323739306563308379279dc483f7cf208401c9c380c483042c2284602647d585a8b175a4dc860117dfd6ba32c080888995446ca72b2d5682047dc080f90110b842307862633735653131623033656563303064313132393133346166396535363865343638376235336431643830616161373435626265623737626262356336616230b842307832663162386464653462666662303532633730656530383234303431373163663233393961656565386534366630396363353864343464346234376566383463b842307834616630336139363662323931656233343430343466613531336631303630626331636137663565633137303831393034343937336339356263376235383466b842307836383961653530326134316562656666333630353439636561303235623535366136666531363064643764643439643936343638393563663036393765333365`},
		{
			json: `{"hash":"0xa6528367a9287ed3a66fc64457db15e2aaa93104a3fd06d4f0a2beb6cc1f26c8","parentHash":"0x5aef321e4e49f430ad6322af8a0133eae83e635f7893c996eb127dcf24a00b14","height":"0x792776","miner":"cfx:aatxetsp0kdarpdb5stdyex11dr3x6sb0jw2gykec0","deferredStateRoot":"0xa979a8c492c44a512aa9529911a7862e1b61ce2aa441645e865def9219d2c68b","deferredReceiptsRoot":"0xd5f7e7960e9b56753868260c280746c01353dcd1b91a20cee2c919d0dc7bf78b","deferredLogsBloomHash":"0xd397b3b043d87fcd6fad1291ff0bfd16401c274896d8c63a923727f077b8e0b5","blame":"0x0","transactionsRoot":"0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470","epochNumber":"0x792778","blockNumber":"0xf7cf1c","gasLimit":"0x1c9c380","gasUsed":"0x0","timestamp":"0x6026478e","difficulty":"0xa8b175a4dc","powQuality":"0x2223e36adc5","refereeHashes":["0x4e4fca2593068b1dc83ecae3c1eaf0e4d41623985fd03d7f15fc1d63f653e7d2"],"adaptive":false,"nonce":"0x209fc5fbe719dace","size":"0x0","custom":[],"posReference":null,"transactions":[]}`,
			rlp:  `f9024cf90248b842307861363532383336376139323837656433613636666336343435376462313565326161613933313034613366643036643466306132626562366363316632366338b84230783561656633323165346534396634333061643633323261663861303133336561653833653633356637383933633939366562313237646366323461303062313483792776f5836366788475736572a200000f13040f0e0c160903000d0c03011b0e0f031404131717030d19131c0e011608881218061409040216b842307861393739613863343932633434613531326161393532393931316137383632653162363163653261613434313634356538363564656639323139643263363862b842307864356637653739363065396235363735333836383236306332383037343663303133353364636431623931613230636565326339313964306463376266373862b84230786433393762336230343364383766636436666164313239316666306266643136343031633237343839366438633633613932333732376630373762386530623580b84230786335643234363031383666373233336339323765376462326463633730336330653530306236353363613832323733623762666164383034356438356134373083792778c483f7cf1c8401c9c380c180846026478e85a8b175a4dc8602223e36adc5f844b8423078346534666361323539333036386231646338336563616533633165616630653464343136323339383566643033643766313566633164363366363533653764328088209fc5fbe719dace80c080c0`,
		},
		// 1559
		{
			json: `{"hash":"0x7fab5518a46d13a4d8b5c32d953872f41225a6bd5876781e97b094ef3ff03d4f","parentHash":"0xdda233f61d4c2b6b1526831bf9cd48144c3032cd864ca2779c329760edd6a283","height":"0x14e997","miner":"net8888:aajaaaaaaaaaaaaaaaaaaaaaaaaaaaaabux08ucy6f","deferredStateRoot":"0xaed49a6fe6bfb3c98d8b767080161590ed08e516a10b26b7fbe5b3a6f86038bf","deferredReceiptsRoot":"0x09f8709ea9f344a810811a373b30861568f5686e649d6177fd92ea2db7477508","deferredLogsBloomHash":"0xd397b3b043d87fcd6fad1291ff0bfd16401c274896d8c63a923727f077b8e0b5","blame":"0x0","transactionsRoot":"0x32c3c4f7d6b706cd4bdb158a58b441a6bf05847dfe33edf78b7cd2f708197805","epochNumber":"0x14e997","blockNumber":"0x178335","gasLimit":"0x3938700","gasUsed":"0x62d4","baseFeePerGas":"0x3b9aca00","timestamp":"0x66690a60","difficulty":"0x2cf","powQuality":"0x565","refereeHashes":[],"adaptive":false,"nonce":"0x659c4c09269d4b2c","size":"0xb4","custom":["0x04"],"posReference":"0x181c59f93232a2dca79123f3f23396920ec779516f6b86f0e94a84e7803588e0","transactions":["0x79bc3f80eebc0c367c0d8749eb5134c6c0523477b92cbde9d2b36b9f1402a216"]}`,
			rlp:  `f90296f9024db842307837666162353531386134366431336134643862356333326439353338373266343132323561366264353837363738316539376230393465663366663033643466b8423078646461323333663631643463326236623135323638333162663963643438313434633330333263643836346361323737396333323937363065646436613238338314e997f839876e6574383838388475736572a2000008000000000000000000000000000000000000000000000000000000000001108813161e1002141c05b842307861656434396136666536626662336339386438623736373038303136313539306564303865353136613130623236623766626535623361366638363033386266b842307830396638373039656139663334346138313038313161333733623330383631353638663536383665363439643631373766643932656132646237343737353038b84230786433393762336230343364383766636436666164313239316666306266643136343031633237343839366438633633613932333732376630373762386530623580b8423078333263336334663764366237303663643462646231353861353862343431613662663035383437646665333365646637386237636432663730383139373830358314e997c4831783358403938700c38262d4843b9aca008466690a608202cf820565c08088659c4c09269d4b2c81b4c104b842307831383163353966393332333261326463613739313233663366323333393639323065633737393531366636623836663065393461383465373830333538386530f844b842307837396263336638306565626330633336376330643837343965623531333463366330353233343737623932636264653964326233366239663134303261323136`,
		},
	}

	t.Run("Encode", func(t *testing.T) {
		for _, item := range table {
			// Encode
			var b BlockSummary
			err := utils.JsonUnmarshal([]byte(item.json), &b)
			assert.NoError(t, err)

			rlpEncoded, err := rlp.EncodeToBytes(b)
			assert.NoError(t, err)

			assert.Equal(t, item.rlp, hex.EncodeToString(rlpEncoded))
		}
	})

	t.Run("Decode", func(t *testing.T) {
		for _, item := range table {
			// Decode
			var b BlockSummary
			dBytes, err := hex.DecodeString(item.rlp)
			assert.NoError(t, err)

			err = rlp.DecodeBytes(dBytes, &b)
			assert.NoError(t, err)

			j, err := utils.JsonMarshal(b)
			assert.NoError(t, err)

			assert.Equal(t, item.json, string(j))
		}
	})
}

func TestJsonMarshalBlock(t *testing.T) {
	jsons := []string{
		`{"hash":"0x6720dc2e79931b4727289612cb3a8ead65f65a3cd1d079348601c52116713b73","parentHash":"0x9154c74219f6e556372e252cf2dd9e675ebcf1a7c257e31cf5a8c3cd79c336f5","height":"0x22","miner":"net8888:aajaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaph895n0mm","deferredStateRoot":"0x223ca6a2e599d487f739a0586bf26c88b8032f10f7607cb4e623d100675ef3b0","deferredReceiptsRoot":"0x09f8709ea9f344a810811a373b30861568f5686e649d6177fd92ea2db7477508","deferredLogsBloomHash":"0xd397b3b043d87fcd6fad1291ff0bfd16401c274896d8c63a923727f077b8e0b5","blame":"0x0","transactionsRoot":"0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470","epochNumber":"0x22","blockNumber":"0x22","gasLimit":"0x1c9c380","gasUsed":"0x0","timestamp":"0x619daead","difficulty":"0x1f4","powQuality":"0x1f6","refereeHashes":[],"adaptive":false,"nonce":"0x865a421661e90c0e","size":"0x0","custom":[],"posReference":null,"transactions":[]}`,
		`{"hash":"0x6720dc2e79931b4727289612cb3a8ead65f65a3cd1d079348601c52116713b73","parentHash":"0x9154c74219f6e556372e252cf2dd9e675ebcf1a7c257e31cf5a8c3cd79c336f5","height":"0x22","miner":"net8888:aajaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaph895n0mm","deferredStateRoot":"0x223ca6a2e599d487f739a0586bf26c88b8032f10f7607cb4e623d100675ef3b0","deferredReceiptsRoot":"0x09f8709ea9f344a810811a373b30861568f5686e649d6177fd92ea2db7477508","deferredLogsBloomHash":"0xd397b3b043d87fcd6fad1291ff0bfd16401c274896d8c63a923727f077b8e0b5","blame":"0x0","transactionsRoot":"0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470","epochNumber":"0x22","blockNumber":"0x22","gasLimit":"0x1c9c380","gasUsed":"0x0","timestamp":"0x619daead","difficulty":"0x1f4","powQuality":"0x1f6","refereeHashes":[],"adaptive":false,"nonce":"0x865a421661e90c0e","size":"0x0","custom":["0x0102"],"posReference":null,"transactions":[]}`,
	}
	for _, j := range jsons {
		var b Block
		e := utils.JsonUnmarshal([]byte(j), &b)
		if e != nil {
			t.Fatal(e)
		}
		// fmt.Printf("%+v\n", b)
		d, e := utils.JsonMarshal(b)
		if e != nil {
			t.Fatal(e)
		}
		assert.Equal(t, j, string(d))
	}
}
